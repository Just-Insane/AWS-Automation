- name: Install updates
  yum: name=* state=latest
  become: yes

- name: Setup nginx repo
  yum_repository:
    name: nginx
    description: NGINX Repo
    baseurl: http://nginx.org/packages/rhel/7/$basearch/
    gpgcheck: no
    enabled: yes
  become: yes

- name: Install packages
  yum:
    name: "{{ item }}"
    state: latest
  with_items:
    - nginx
    - git
  become: yes

- name: Get Node.JS
  shell: curl --silent --location https://rpm.nodesource.com/setup_10.x | sudo bash -

- name: Install Node.JS
  yum:
    name: "{{ item }}"
    state: latest
  with_items:
    - nodejs
    - gcc-c++
    - make
  become: yes

- name: Curl credentials
  shell: curl http://169.254.169.254/latest/meta-data/iam/security-credentials/DynamoDB-Admin

# - name: Remove default nginx files
#   file:
#     state: absent
#     path: /usr/share/nginx/html/
#   become: yes

- name: Pull git repo
  git:
    repo: 'https://github.com/Just-Insane/FortuneSite.git'
    dest: /home/ec2-user/FortuneSite/
    version: master

- name: Setup FortuneSite Service
  copy:
    src: fortunesite.service
    dest: /etc/systemd/system
    owner: root
    group: root
    mode: 0755
  become: yes

- name: Install dependancies
  shell: cd /home/ec2-user/FortuneSite/ && npm install

- name: Start FortuneSite Service
  service:
    name: FortuneSite
    state: restarted
    enabled: yes
  become: yes

# - name: Set path permissions
#   file:
#     path: /usr/share/nginx/html
#     owner: nginx
#     group: nginx
#     mode: 0755
#   become: yes

- name: Copy nginx conf file
  copy:
    src: nginx.conf
    dest: /etc/nginx/nginx.conf
    owner: root
    group: root
    mode: 0644
    backup: yes
  become: yes

- name: Start service nginx, if not running
  service:
    name: nginx
    state: restarted
    enabled: yes
  become: yes